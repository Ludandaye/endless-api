<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>endless-api</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="/static/js/assistant.js"></script>
    
    <style>
        /* é‡ç½®æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* å®¹å™¨ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨ */
        .header {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .header-subtitle {
            color: #6c757d;
            font-size: 14px;
            margin-top: 4px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .api-key-info {
            font-size: 14px;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .login-status {
            font-weight: 500;
            color: #28a745;
            padding: 4px 8px;
            border-radius: 4px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .login-status.offline {
            color: #dc3545;
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .api-key-masked {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            color: #495057;
            font-size: 12px;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border: 1px solid #e9ecef;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .status-indicator.online {
            background: #28a745;
        }

        .status-indicator.offline {
            background: #dc3545;
        }

        .status-indicator.loading {
            background: #6c757d;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* é€‰é¡¹å¡ */
        .tabs {
            margin-bottom: 24px;
        }

        .tabs-nav {
            display: flex;
            gap: 4px;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #6c757d;
        }

        .tab-button.active {
            background: #007bff;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #f8f9fa;
        }

        /* é¢æ¿ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid {
            display: grid;
            gap: 24px;
            grid-template-columns: 2fr 1fr;
        }

        /* å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clear-btn:hover {
            background: #c82333;
        }

        /* èŠå¤©æ¶ˆæ¯ */
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #f8f9fa;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
        }

        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            border: 1px solid #e9ecef;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-role {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chat-placeholder {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        /* è¾“å…¥ç»„ */
        .input-group {
            display: flex;
            gap: 12px;
        }

        .form-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-full {
            width: 100%;
            margin-bottom: 16px;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* è¡¨å•ç»„ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 6px;
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            outline: none;
        }

        .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
            outline: none;
        }

        .form-textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* ç»“æœåŒºåŸŸ */
        .result-area {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            background: #f8f9fa;
        }

        .result-area::-webkit-scrollbar {
            width: 6px;
        }

        .result-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .result-area::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .result-placeholder {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .result-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .result-loading {
            text-align: center;
            color: #007bff;
        }

        .result-error {
            color: #dc3545;
        }

        /* å·¥å…·ç±» */
        .hidden {
            display: none !important;
        }

        /* æ‰¹é‡å¤„ç†æ ·å¼ */
        .batch-textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .batch-controls {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .batch-results {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 300px;
        }

        .batch-results:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .batch-progress {
            margin: 16px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #6c757d;
            text-align: center;
        }

        .batch-stats {
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .batch-stats h4 {
            margin-bottom: 8px;
            font-size: 14px;
            color: #495057;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .stat-label {
            color: #6c757d;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .form-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-copy {
            background: #6c757d;
            color: white;
            font-size: 12px;
            padding: 4px 8px;
            margin-left: 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .btn-copy:hover {
            background: #545b62;
            transform: translateY(-1px);
        }

        /* ä¼˜åŒ–æ ‡ç­¾å¸ƒå±€ */
        .form-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        /* èŠå¤©æ“ä½œåŒºåŸŸ */
        .chat-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .file-upload-area {
            margin: 16px 0;
        }

        .file-upload-zone {
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-zone:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .file-upload-zone.dragover {
            border-color: #007bff;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .upload-text p {
            margin: 8px 0;
            color: #6c757d;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
        }

        .upload-tips {
            font-size: 11px;
            color: #6c757d;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
        }

        .upload-btn {
            background: none;
            border: none;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            font: inherit;
        }

        .upload-btn:hover {
            color: #0056b3;
        }

        /* ä¸Šä¼ æ–‡ä»¶é¢„è§ˆ */
        .uploaded-files {
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .uploaded-files h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #495057;
        }

        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .file-count {
            font-weight: bold;
            color: #007bff;
        }

        .file-size-total {
            font-size: 13px;
            color: #6c757d;
        }

        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
        }

        .file-item.image {
            position: relative;
        }

        .file-item .file-icon {
            font-size: 16px;
        }

        .file-item .file-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-item .file-size {
            font-size: 11px;
            color: #6c757d;
        }

        .file-item .remove-file {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-item .remove-file:hover {
            background: #c82333;
        }

        /* å›¾ç‰‡é¢„è§ˆ */
        .image-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 8px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* æ–‡ä»¶æ“ä½œåŒºåŸŸ */
        .file-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #dee2e6;
        }

        /* èŠå¤©ä¸­çš„æ–‡ä»¶é¢„è§ˆ */
        .file-preview-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .image-preview-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .input-group {
                flex-direction: column;
            }

            .tabs-nav {
                flex-direction: column;
                gap: 2px;
            }

            .message {
                max-width: 95%;
            }
        }

        /* è‡ªå®šä¹‰åŠ©æ‰‹æ ·å¼ */
        .assistant-textarea {
            min-height: 150px;
            font-family: inherit;
        }

        .assistant-controls {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .assistant-result {
            min-height: 200px;
        }

        .assistant-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            background: #f8f9fa;
        }

        .assistant-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .assistant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .assistant-header h4 {
            margin: 0;
            font-size: 14px;
            color: #495057;
        }

        .assistant-date {
            font-size: 12px;
            color: #6c757d;
        }

        .assistant-preview {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .assistant-actions {
            display: flex;
            gap: 8px;
        }

        .assistant-placeholder {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }

        .success-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .success-result h4 {
            color: #155724;
            margin-bottom: 12px;
        }

        .assistant-info {
            margin-bottom: 16px;
        }

        .assistant-info p {
            margin: 4px 0;
            font-size: 14px;
        }

        .system-prompt {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .assistant-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .error-result {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 16px;
            color: #721c24;
        }

        .loading {
            text-align: center;
            color: #007bff;
            padding: 20px;
        }

        .assistant-tips {
            margin-top: 20px;
            padding: 16px;
            background: #e3f2fd;
            border-radius: 8px;
            border: 1px solid #bbdefb;
        }

        .assistant-tips h4 {
            color: #1565c0;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .assistant-tips ul {
            margin: 0;
            padding-left: 20px;
        }

        .assistant-tips li {
            margin: 4px 0;
            font-size: 13px;
            color: #1976d2;
        }

        /* å“åº”å¼è®¾è®¡ */

        /* åŠ©æ‰‹æŒ‡ç¤ºå™¨æ ·å¼ */
        .assistant-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 12px;
        }

        .assistant-badge {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .chat-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* å“åº”å¼è®¾è®¡ */
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div class="header-info">
                <h1 class="header-title">endless-api</h1>
                <p class="header-subtitle">OpenAI API è°ƒç”¨å¹³å°</p>
            </div>
            <div class="user-info">
                <div class="api-key-info">
                    <span>çŠ¶æ€: </span>
                    <span id="login-status" class="login-status">å·²ç™»å½•</span>
                </div>
                <button onclick="logout()" class="logout-btn">é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="status">
            <div id="status-indicator" class="status-indicator loading"></div>
            <span id="status-text">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ä¸­...</span>
        </div>

        <!-- é€‰é¡¹å¡ -->
        <div class="tabs">
            <nav class="tabs-nav">
                <button onclick="switchTab('chat')" id="chat-tab" class="tab-button active">
                    ğŸ’¬ èŠå¤©å¯¹è¯
                </button>
                <button onclick="switchTab('completion')" id="completion-tab" class="tab-button">
                    ğŸ“ æ–‡æœ¬è¡¥å…¨
                </button>
                <button onclick="switchTab('json-batch')" id="json-batch-tab" class="tab-button">
                    ğŸ“Š JSONæ‰¹é‡å¤„ç†
                </button>
                <button onclick="switchTab('custom-assistant')" id="custom-assistant-tab" class="tab-button">
                    ğŸ¤– è‡ªå®šä¹‰åŠ©æ‰‹
                </button>
            </nav>
        </div>

        <!-- èŠå¤©å¯¹è¯é¢æ¿ -->
        <div id="chat-panel" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">èŠå¤©å¯¹è¯</h2>
                        <div class="chat-actions">
                            <div id="current-assistant-indicator" class="assistant-indicator" style="display: none;">
                                <span class="assistant-badge">ğŸ¤– è‡ªå®šä¹‰åŠ©æ‰‹</span>
                            </div>
                            <button onclick="copyChatHistory()" id="copy-chat-btn" class="btn btn-copy" style="display: none;">
                                ğŸ“‹ å¤åˆ¶å¯¹è¯
                            </button>
                            <button onclick="clearHistory()" class="clear-btn">æ¸…é™¤å†å²</button>
                        </div>
                    </div>
                    
                    <div id="chat-messages" class="chat-messages">
                        <div class="chat-placeholder">å¼€å§‹å¯¹è¯...</div>
                    </div>
                    
                    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="file-upload-area" id="file-upload-area">
                        <div class="file-upload-zone" id="file-upload-zone">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">
                                <p><strong>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</strong> æˆ– <button class="upload-btn" onclick="triggerFileSelect()">é€‰æ‹©æ–‡ä»¶</button></p>
                                <p class="upload-hint">æ”¯æŒå›¾ç‰‡è¯†åˆ« (jpg, png, gif, webp) å’Œæ–‡æœ¬æ–‡ä»¶ (txt, md, doc, pdf)</p>
                                <p class="upload-tips">ğŸ’¡ å¿«æ·é”®: Ctrl+U ä¸Šä¼ æ–‡ä»¶ | ESC æ¸…é™¤æ–‡ä»¶ | æœ€å¤§10MB</p>
                            </div>
                            <input type="file" id="file-input" multiple accept="image/*,.txt,.md,.doc,.docx,.pdf" style="display: none;">
                        </div>
                        
                        <!-- ä¸Šä¼ æ–‡ä»¶é¢„è§ˆ -->
                        <div class="uploaded-files" id="uploaded-files" style="display: none;">
                            <div class="files-header">
                                <h4>å·²ä¸Šä¼ æ–‡ä»¶: <span id="file-count">0</span></h4>
                                <span class="file-size-total" id="file-size-total">æ€»å¤§å°: 0 B</span>
                            </div>
                            <div class="file-list" id="file-list"></div>
                            <div class="file-actions">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="keep-files-after-send" checked>
                                    å‘é€åä¿ç•™æ–‡ä»¶
                                </label>
                                <button class="btn btn-warning btn-sm" onclick="clearUploadedFiles()">æ¸…é™¤æ‰€æœ‰æ–‡ä»¶</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" id="chat-input" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." class="form-input">
                        <button onclick="sendChatMessage()" id="send-chat-btn" class="btn btn-primary">å‘é€</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">èŠå¤©è®¾ç½®</h3>
                    
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹</label>
                        <select id="chat-model" class="form-select">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æœ€å¤§Tokenæ•°</label>
                        <input type="number" id="chat-max-tokens" value="1000" min="1" max="4000" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ¸©åº¦ (0-2)</label>
                        <input type="number" id="chat-temperature" value="0.7" min="0" max="2" step="0.1" class="form-input">
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡æœ¬è¡¥å…¨é¢æ¿ -->
        <div id="completion-panel" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2 class="card-title">æ–‡æœ¬è¡¥å…¨</h2>
                    
                    <div class="form-group">
                        <label class="form-label">æç¤ºæ–‡æœ¬</label>
                        <textarea id="completion-prompt" placeholder="è¾“å…¥æ‚¨çš„æç¤ºæ–‡æœ¬..." class="form-textarea"></textarea>
                    </div>
                    
                    <button onclick="generateCompletion()" id="generate-completion-btn" class="btn btn-success btn-full">
                        ç”Ÿæˆè¡¥å…¨
                    </button>
                    
                    <div class="form-group">
                        <label class="form-label">ç”Ÿæˆç»“æœ
                            <button onclick="copyCompletionResult()" id="copy-completion-btn" class="btn btn-copy" style="display: none;">
                                ğŸ“‹ å¤åˆ¶ç»“æœ
                            </button>
                        </label>
                        <div id="completion-result" class="result-area">
                            <div class="result-placeholder">è¡¥å…¨ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">è¡¥å…¨è®¾ç½®</h3>
                    
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹</label>
                        <select id="completion-model" class="form-select">
                            <option value="gpt-3.5-turbo-instruct">GPT-3.5 Turbo Instruct</option>
                            <option value="davinci-002">Davinci 002</option>
                            <option value="babbage-002">Babbage 002</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æœ€å¤§Tokenæ•°</label>
                        <input type="number" id="completion-max-tokens" value="1000" min="1" max="4000" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ¸©åº¦ (0-2)</label>
                        <input type="number" id="completion-temperature" value="0.7" min="0" max="2" step="0.1" class="form-input">
                    </div>
                </div>
            </div>
        </div>

        <!-- JSONæ‰¹é‡å¤„ç†é¢æ¿ -->
        <div id="json-batch-panel" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2 class="card-title">JSONæ‰¹é‡å¤„ç†</h2>
                    
                    <div class="form-group">
                        <label class="form-label">JSONæç¤ºåˆ—è¡¨</label>
                        <textarea 
                            id="json-batch-input" 
                            placeholder='è¾“å…¥JSONæ ¼å¼çš„æç¤ºåˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š

[
  {"prompt": "ç¿»è¯‘æˆè‹±æ–‡ï¼šä½ å¥½ä¸–ç•Œ"},
  {"prompt": "å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—"},
  {"prompt": "è§£é‡Šä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½"},
  {"prompt": "è®¡ç®— 123 + 456 ç­‰äºå¤šå°‘"}
]

æ³¨æ„ï¼š
1. å¤–å±‚å¿…é¡»æ˜¯æ–¹æ‹¬å· []
2. æ¯ä¸ªå¯¹è±¡ç”¨å¤§æ‹¬å· {}
3. promptå­—æ®µå¿…é¡»æ˜¯å­—ç¬¦ä¸²
4. å¯¹è±¡ä¹‹é—´ç”¨é€—å·åˆ†éš”' 
                            class="form-textarea batch-textarea"></textarea>
                    </div>
                    
                    <div class="batch-controls">
                        <button onclick="validateJsonInput()" class="btn btn-secondary">
                            âœ… éªŒè¯JSONæ ¼å¼
                        </button>
                        <button onclick="processBatch()" id="process-batch-btn" class="btn btn-success">
                            ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç†
                        </button>
                        <button onclick="clearBatchResults()" class="btn btn-warning">
                            ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å¤„ç†ç»“æœ
                            <button onclick="copyBatchResults()" id="copy-results-btn" class="btn btn-copy" style="display: none;">
                                ğŸ“‹ å¤åˆ¶ç»“æœ
                            </button>
                        </label>
                        <div id="batch-results" class="result-area batch-results" tabindex="0">
                            <div class="result-placeholder">æ‰¹é‡å¤„ç†ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
                        </div>
                    </div>
                    
                    <div class="batch-progress" id="batch-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text" id="progress-text">å¤„ç†ä¸­... 0/0</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">æ‰¹é‡å¤„ç†è®¾ç½®</h3>
                    
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹</label>
                        <select id="batch-model" class="form-select">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æœ€å¤§Tokenæ•°</label>
                        <input type="number" id="batch-max-tokens" value="1000" min="1" max="4000" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ¸©åº¦ (0-2)</label>
                        <input type="number" id="batch-temperature" value="0.7" min="0" max="2" step="0.1" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å¹¶å‘æ•°é‡</label>
                        <input type="number" id="batch-concurrent" value="3" min="1" max="10" class="form-input">
                        <small class="form-text">åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼ˆå»ºè®®1-5ï¼‰</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¯·æ±‚é—´éš” (æ¯«ç§’)</label>
                        <input type="number" id="batch-delay" value="1000" min="0" max="5000" step="100" class="form-input">
                        <small class="form-text">è¯·æ±‚ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´</small>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="batch-include-metadata" checked>
                                åŒ…å«å…ƒæ•°æ®ï¼ˆè€—æ—¶ã€Tokenç­‰ï¼‰
                            </label>
                        </div>
                    </div>
                    
                    <div class="batch-stats" id="batch-stats" style="display: none;">
                        <h4>ç»Ÿè®¡ä¿¡æ¯</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">æ€»æ•°é‡:</span>
                                <span id="stat-total">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æˆåŠŸ:</span>
                                <span id="stat-success">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">å¤±è´¥:</span>
                                <span id="stat-error">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æ€»Token:</span>
                                <span id="stat-tokens">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‡ªå®šä¹‰åŠ©æ‰‹é¢æ¿ -->
        <div id="custom-assistant-panel" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2 class="card-title">åˆ›å»ºè‡ªå®šä¹‰åŠ©æ‰‹</h2>
                    
                    <div class="form-group">
                        <label class="form-label">åŠ©æ‰‹éœ€æ±‚æè¿°</label>
                        <textarea 
                            id="assistant-request" 
                            placeholder='è¯·è¯¦ç»†æè¿°æ‚¨éœ€è¦çš„åŠ©æ‰‹åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š

â€¢ ç¿»è¯‘åŠ©æ‰‹ï¼šå¸®æˆ‘ç¿»è¯‘å„ç§è¯­è¨€ï¼Œæ”¯æŒä¸­è‹±æ—¥éŸ©ç­‰
â€¢ ç¼–ç¨‹åŠ©æ‰‹ï¼šå¸®æˆ‘å†™ä»£ç ã€è°ƒè¯•ã€è§£é‡ŠæŠ€æœ¯é—®é¢˜
â€¢ å†™ä½œåŠ©æ‰‹ï¼šå¸®æˆ‘å†™æ–‡ç« ã€é‚®ä»¶ã€æŠ¥å‘Šç­‰
â€¢ å­¦ä¹ åŠ©æ‰‹ï¼šå¸®æˆ‘åˆ¶å®šå­¦ä¹ è®¡åˆ’ã€è§£ç­”é—®é¢˜
â€¢ åˆ›æ„åŠ©æ‰‹ï¼šå¸®æˆ‘ç”Ÿæˆåˆ›æ„ã€å¤´è„‘é£æš´
â€¢ æ•°æ®åˆ†æåŠ©æ‰‹ï¼šå¸®æˆ‘åˆ†ææ•°æ®ã€åˆ¶ä½œå›¾è¡¨

æè¿°è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„åŠ©æ‰‹è¶Šç¬¦åˆæ‚¨çš„éœ€æ±‚ã€‚' 
                            class="form-textarea assistant-textarea"></textarea>
                    </div>
                    
                    <div class="assistant-controls">
                        <button onclick="testButtonClick()" class="btn btn-secondary">
                            ğŸ§ª æµ‹è¯•æŒ‰é’®ç‚¹å‡»
                        </button>
                        <button onclick="createCustomAssistant()" id="create-assistant-btn" class="btn btn-success">
                            ğŸ¤– åˆ›å»ºåŠ©æ‰‹
                        </button>
                        <button onclick="clearAssistantForm()" class="btn btn-warning">
                            ğŸ—‘ï¸ æ¸…ç©ºè¡¨å•
                        </button>
                        <button onclick="testAssistantFunctions()" class="btn btn-secondary">
                            ğŸ” è°ƒè¯•æµ‹è¯•
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åˆ›å»ºç»“æœ
                            <button onclick="copyAssistantResult()" id="copy-assistant-btn" class="btn btn-copy" style="display: none;">
                                ğŸ“‹ å¤åˆ¶ç»“æœ
                            </button>
                        </label>
                        <div id="assistant-result" class="result-area assistant-result" tabindex="0">
                            <div class="result-placeholder">åŠ©æ‰‹åˆ›å»ºç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">åŠ©æ‰‹è®¾ç½®</h3>
                    
                    <div class="form-group">
                        <label class="form-label">ç”Ÿæˆæ¨¡å‹</label>
                        <select id="assistant-model" class="form-select">
                            <option value="gpt-4">GPT-4 (æ¨è)</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                        <small class="form-text">ç”¨äºç”Ÿæˆsystem promptçš„æ¨¡å‹</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æˆ‘çš„åŠ©æ‰‹åˆ—è¡¨</label>
                        <div id="assistant-list" class="assistant-list">
                            <div class="assistant-placeholder">æ‚¨åˆ›å»ºçš„åŠ©æ‰‹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
                        </div>
                    </div>
                    
                    <div class="assistant-tips">
                        <h4>ğŸ’¡ ä½¿ç”¨æç¤º</h4>
                        <ul>
                            <li>æè¿°è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„åŠ©æ‰‹è¶Šä¸“ä¸š</li>
                            <li>å¯ä»¥æŒ‡å®šåŠ©æ‰‹çš„æ€§æ ¼ã€èƒ½åŠ›ã€å·¥ä½œæ–¹å¼</li>
                            <li>åˆ›å»ºåå¯ä»¥ç›´æ¥åœ¨èŠå¤©ä¸­ä½¿ç”¨</li>
                            <li>æ¯ä¸ªåŠ©æ‰‹éƒ½æœ‰ç‹¬ç‰¹çš„system prompt</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä¸»é¡µé¢JavaScript
        let isLoading = false;
        let currentTab = 'chat';
        let currentConversationId = null; // å½“å‰å¯¹è¯ID

        // è®¾ç½®å½“å‰å¯¹è¯
        function setCurrentConversation(conversationId) {
            currentConversationId = conversationId;
            console.log('è®¾ç½®å½“å‰å¯¹è¯ID:', conversationId);
            
            // æ›´æ–°èŠå¤©è¾“å…¥æ¡†æç¤º
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.placeholder = 'ç°åœ¨æ‚¨å¯ä»¥ä¸è‡ªå®šä¹‰åŠ©æ‰‹å¯¹è¯äº†...';
            }
            
            // æ˜¾ç¤ºåŠ©æ‰‹æŒ‡ç¤ºå™¨
            const assistantIndicator = document.getElementById('current-assistant-indicator');
            if (assistantIndicator) {
                assistantIndicator.style.display = 'flex';
            }
        }

        // æ¸…é™¤å½“å‰å¯¹è¯
        function clearCurrentConversation() {
            currentConversationId = null;
            console.log('æ¸…é™¤å½“å‰å¯¹è¯ID');
            
            // æ¢å¤èŠå¤©è¾“å…¥æ¡†æç¤º
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.placeholder = 'è¾“å…¥æ‚¨çš„æ¶ˆæ¯...';
            }
            
            // éšè—åŠ©æ‰‹æŒ‡ç¤ºå™¨
            const assistantIndicator = document.getElementById('current-assistant-indicator');
            if (assistantIndicator) {
                assistantIndicator.style.display = 'none';
            }
        }

        // æµ‹è¯•è‡ªå®šä¹‰åŠ©æ‰‹åŠŸèƒ½æ˜¯å¦å¯ç”¨
        function testAssistantFunctions() {
            console.log('æµ‹è¯•è‡ªå®šä¹‰åŠ©æ‰‹åŠŸèƒ½...');
            console.log('createCustomAssistantå‡½æ•°:', typeof createCustomAssistant);
            console.log('clearAssistantFormå‡½æ•°:', typeof clearAssistantForm);
            console.log('copyAssistantResultå‡½æ•°:', typeof copyAssistantResult);
            console.log('loadAssistantListå‡½æ•°:', typeof loadAssistantList);
            
            // æ£€æŸ¥DOMå…ƒç´ 
            const elements = [
                'assistant-request',
                'assistant-model', 
                'assistant-result',
                'create-assistant-btn',
                'assistant-list'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}å…ƒç´ :`, element ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            });
        }

        // æµ‹è¯•æŒ‰é’®ç‚¹å‡»åŠŸèƒ½
        function testButtonClick() {
            alert('âœ… æŒ‰é’®ç‚¹å‡»åŠŸèƒ½æ­£å¸¸ï¼');
            console.log('æŒ‰é’®ç‚¹å‡»æµ‹è¯•æˆåŠŸ');
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é¡µé¢
            initializePage();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            checkStatus();
            
            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            initFileUpload();
            
            // æµ‹è¯•è‡ªå®šä¹‰åŠ©æ‰‹åŠŸèƒ½
            setTimeout(testAssistantFunctions, 2000);
        });

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // è®¾ç½®é»˜è®¤é€‰é¡¹å¡
            switchTab('chat');
            
            // åˆå§‹åŒ–èŠå¤©ç•Œé¢
            initializeChatInterface();
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // èŠå¤©è¾“å…¥æ¡†å›è½¦é”®ç›‘å¬
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
            
            // è¡¥å…¨æ–‡æœ¬åŒºåŸŸå¿«æ·é”®ç›‘å¬
            const completionPrompt = document.getElementById('completion-prompt');
            if (completionPrompt) {
                completionPrompt.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        generateCompletion();
                    }
                });
            }
        }

        // åˆå§‹åŒ–èŠå¤©ç•Œé¢
        function initializeChatInterface() {
            const messagesDiv = document.getElementById('chat-messages');
            if (messagesDiv) {
                messagesDiv.innerHTML = '<div class="chat-placeholder">å¼€å§‹å¯¹è¯...</div>';
            }
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkStatus() {
            try {
                const response = await axios.get('/api/status');
                const status = response.data;
                
                updateStatusIndicator(status);
                updateUserInfo(status);
                
                if (!status.logged_in) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                updateStatusIndicator({ 
                    status: 'error', 
                    logged_in: false 
                });
            }
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatusIndicator(status) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            if (!indicator || !statusText) return;
            
            indicator.classList.remove('online', 'offline', 'loading');
            
            if (status.logged_in && status.status === 'running') {
                indicator.classList.add('online');
                statusText.textContent = 'ç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼Œå·²ç™»å½•';
            } else if (!status.logged_in) {
                indicator.classList.add('offline');
                statusText.textContent = 'æœªç™»å½•';
            } else {
                indicator.classList.add('offline');
                statusText.textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
            }
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        function updateUserInfo(status) {
            const loginStatus = document.getElementById('login-status');
            
            if (!loginStatus) return;
            
            if (status.logged_in) {
                loginStatus.textContent = 'å·²ç™»å½•';
                loginStatus.className = 'login-status';
            } else {
                loginStatus.textContent = 'æœªç™»å½•';
                loginStatus.className = 'login-status offline';
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                await axios.post('/logout');
                window.location.href = '/login';
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                alert('é€€å‡ºç™»å½•å¤±è´¥: ' + (error.response?.data?.error || error.message));
            }
        }

        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰å†…å®¹é¢æ¿
            document.querySelectorAll('.tab-content').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // é‡ç½®æ‰€æœ‰é€‰é¡¹å¡æŒ‰é’®æ ·å¼
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„é¢æ¿
            const targetPanel = document.getElementById(tabName + '-panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            // æ¿€æ´»é€‰ä¸­çš„é€‰é¡¹å¡æŒ‰é’®
            const activeTab = document.getElementById(tabName + '-tab');
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // æ›´æ–°å½“å‰é€‰é¡¹å¡
            currentTab = tabName;
            
            // é€‰é¡¹å¡åˆ‡æ¢åçš„å¤„ç†
            onTabSwitch(tabName);
        }

        // é€‰é¡¹å¡åˆ‡æ¢åçš„å¤„ç†
        function onTabSwitch(tabName) {
            if (tabName === 'chat') {
                const chatInput = document.getElementById('chat-input');
                if (chatInput) {
                    chatInput.focus();
                }
            } else if (tabName === 'completion') {
                const completionPrompt = document.getElementById('completion-prompt');
                if (completionPrompt) {
                    completionPrompt.focus();
                }
            }
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            if (isLoading) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯æˆ–æ–‡ä»¶
            if (!message && uploadedFiles.length === 0) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯æˆ–ä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            input.value = '';
            setLoading(true);
            
            // æ„å»ºæ¶ˆæ¯å†…å®¹
            let fullMessage = message;
            const chatSettings = getChatSettings();
            
            // å¦‚æœæœ‰ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
            if (uploadedFiles.length > 0) {
                let fileContent = '';
                
                for (const file of uploadedFiles) {
                    if (file.isImage) {
                        // å›¾ç‰‡è¯†åˆ«
                        fileContent += `\n\n[å›¾ç‰‡: ${file.name}]\n`;
                        fileContent += `è¯·åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°çš„å†…å®¹ã€‚`;
                        
                        // å¯¹äºå›¾ç‰‡ï¼Œéœ€è¦ä½¿ç”¨æ”¯æŒè§†è§‰çš„æ¨¡å‹
                        if (chatSettings.model === 'gpt-3.5-turbo') {
                            chatSettings.model = 'gpt-4o'; // è‡ªåŠ¨åˆ‡æ¢åˆ°æ”¯æŒè§†è§‰çš„æ¨¡å‹
                        }
                    } else {
                        // æ–‡æœ¬æ–‡ä»¶å†…å®¹
                        fileContent += `\n\n[æ–‡ä»¶: ${file.name}]\n`;
                        fileContent += `æ–‡ä»¶å†…å®¹:\n${file.content}\n`;
                    }
                }
                
                if (message) {
                    fullMessage = `${message}\n${fileContent}`;
                } else {
                    fullMessage = `è¯·å¤„ç†ä»¥ä¸‹æ–‡ä»¶å†…å®¹:${fileContent}`;
                }
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«æ–‡ä»¶é¢„è§ˆï¼‰
            addMessageToChat('user', message || 'å‘é€äº†æ–‡ä»¶', uploadedFiles);
            
            try {
                const requestData = {
                    message: fullMessage,
                    ...chatSettings
                };
                
                // å¦‚æœæœ‰å½“å‰å¯¹è¯IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (currentConversationId) {
                    requestData.conversation_id = currentConversationId;
                    console.log('ä½¿ç”¨è‡ªå®šä¹‰åŠ©æ‰‹å¯¹è¯ID:', currentConversationId);
                }
                
                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æ•°æ®
                const imageFiles = uploadedFiles.filter(file => file.isImage);
                if (imageFiles.length > 0) {
                    requestData.images = imageFiles.map(file => ({
                        name: file.name,
                        data: file.base64
                    }));
                }
                
                const response = await axios.post('/api/chat', requestData);
                
                addMessageToChat('assistant', response.data.response);
                
                // æ ¹æ®é€‰é¡¹å†³å®šæ˜¯å¦ä¿ç•™æ–‡ä»¶
                if (!document.getElementById('keep-files-after-send').checked) {
                    clearUploadedFiles();
                }
                
            } catch (error) {
                handleApiError(error, 'sendChatMessage');
                addMessageToChat('error', 'é”™è¯¯: ' + getErrorMessage(error));
            } finally {
                setLoading(false);
                input.focus();
            }
        }

        // è·å–èŠå¤©è®¾ç½®
        function getChatSettings() {
            return {
                model: getElementValue('chat-model') || 'gpt-3.5-turbo',
                max_tokens: parseInt(getElementValue('chat-max-tokens')) || 1000,
                temperature: parseFloat(getElementValue('chat-temperature')) || 0.7
            };
        }

        // è·å–è¡¥å…¨è®¾ç½®
        function getCompletionSettings() {
            return {
                model: getElementValue('completion-model') || 'gpt-3.5-turbo-instruct',
                max_tokens: parseInt(getElementValue('completion-max-tokens')) || 1000,
                temperature: parseFloat(getElementValue('completion-temperature')) || 0.7
            };
        }

        // å®‰å…¨è·å–å…ƒç´ å€¼
        function getElementValue(id) {
            const element = document.getElementById(id);
            return element ? element.value : null;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessageToChat(role, content, files = []) {
            const messagesDiv = document.getElementById('chat-messages');
            const copyBtn = document.getElementById('copy-chat-btn');
            
            if (!messagesDiv) return;
            
            const placeholder = messagesDiv.querySelector('.chat-placeholder');
            if (placeholder) {
                messagesDiv.innerHTML = '';
            }
            
            const messageDiv = createMessageElement(role, content, files);
            messagesDiv.appendChild(messageDiv);
            
            scrollToBottom(messagesDiv);
            
            // æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®ï¼ˆå½“æœ‰æ¶ˆæ¯æ—¶ï¼‰
            if (copyBtn) {
                copyBtn.style.display = 'inline-block';
            }
        }

        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        function createMessageElement(role, content, files) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const roleSpan = document.createElement('div');
            roleSpan.className = 'message-role';
            roleSpan.textContent = getRoleDisplayName(role);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (files.length > 0) {
                contentDiv.innerHTML = `<strong>æ–‡ä»¶é¢„è§ˆ:</strong><br>`;
                files.forEach(file => {
                    contentDiv.innerHTML += `<div class="file-preview-item">
                        ${file.isImage ? `<img src="${file.base64}" alt="${file.name}" class="image-preview-preview">` : `
                            <span class="file-icon">${file.isImage ? 'ğŸ–¼ï¸' : 'ğŸ“„'}</span>
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">(${formatFileSize(file.size)})</span>
                        `}
                    </div>`;
                });
            } else {
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(roleSpan);
            messageDiv.appendChild(contentDiv);
            
            return messageDiv;
        }

        // è·å–è§’è‰²æ˜¾ç¤ºåç§°
        function getRoleDisplayName(role) {
            const roleNames = {
                'user': 'ç”¨æˆ·',
                'assistant': 'AIåŠ©æ‰‹',
                'error': 'é”™è¯¯'
            };
            return roleNames[role] || role;
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom(element) {
            if (element) {
                element.scrollTop = element.scrollHeight;
            }
        }

        // æ¸…é™¤èŠå¤©å†å²
        async function clearHistory() {
            try {
                await axios.post('/api/clear_history');
                
                const messagesDiv = document.getElementById('chat-messages');
                const copyBtn = document.getElementById('copy-chat-btn');
                
                if (messagesDiv) {
                    messagesDiv.innerHTML = '<div class="chat-placeholder">èŠå¤©å†å²å·²æ¸…é™¤ï¼Œå¼€å§‹æ–°çš„å¯¹è¯...</div>';
                }
                
                // éšè—å¤åˆ¶æŒ‰é’®
                if (copyBtn) {
                    copyBtn.style.display = 'none';
                }
                
                // æ¸…é™¤å½“å‰å¯¹è¯ID
                clearCurrentConversation();
                
            } catch (error) {
                handleApiError(error, 'clearHistory');
                alert('æ¸…é™¤å†å²å¤±è´¥: ' + getErrorMessage(error));
            }
        }

        // ç”Ÿæˆæ–‡æœ¬è¡¥å…¨
        async function generateCompletion() {
            if (isLoading) return;
            
            const promptElement = document.getElementById('completion-prompt');
            const prompt = promptElement.value.trim();
            
            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºæ–‡æœ¬');
                return;
            }
            
            setLoading(true);
            
            const resultDiv = document.getElementById('completion-result');
            const copyBtn = document.getElementById('copy-completion-btn');
            
            if (resultDiv) {
                resultDiv.innerHTML = '<div class="result-loading">ç”Ÿæˆä¸­...</div>';
            }
            
            try {
                const completionSettings = getCompletionSettings();
                
                const response = await axios.post('/api/completion', {
                    prompt: prompt,
                    ...completionSettings
                });
                
                if (resultDiv) {
                    resultDiv.innerHTML = `<div class="result-content">${response.data.completion}</div>`;
                }
                
                // æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
                if (copyBtn) {
                    copyBtn.style.display = 'inline-block';
                }
                
            } catch (error) {
                handleApiError(error, 'generateCompletion');
                if (resultDiv) {
                    resultDiv.innerHTML = `<div class="result-error">é”™è¯¯: ${getErrorMessage(error)}</div>`;
                }
                
                // éšè—å¤åˆ¶æŒ‰é’®
                if (copyBtn) {
                    copyBtn.style.display = 'none';
                }
            } finally {
                setLoading(false);
            }
        }

        // å¤„ç†APIé”™è¯¯
        function handleApiError(error, context) {
            console.error(`${context} error:`, error);
            
            if (error.response?.status === 401) {
                window.location.href = '/login';
                return;
            }
        }

        // è·å–é”™è¯¯æ¶ˆæ¯
        function getErrorMessage(error) {
            if (error.response?.data?.error) {
                return error.response.data.error;
            } else if (error.request) {
                return 'ç½‘ç»œè¿æ¥å¤±è´¥';
            } else {
                return error.message || 'æœªçŸ¥é”™è¯¯';
            }
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(loading) {
            isLoading = loading;
            
            const buttons = [
                'send-chat-btn',
                'generate-completion-btn',
                'process-batch-btn'
            ];
            
            buttons.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.disabled = loading;
                }
            });
            
            const inputs = [
                'chat-input',
                'completion-prompt',
                'json-batch-input'
            ];
            
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.disabled = loading;
                }
            });
        }

        // JSONæ‰¹é‡å¤„ç†åŠŸèƒ½
        let batchStats = {
            total: 0,
            success: 0,
            error: 0,
            tokens: 0
        };

        // éªŒè¯JSONè¾“å…¥æ ¼å¼
        function validateJsonInput() {
            console.log('å¼€å§‹éªŒè¯JSONæ ¼å¼...');
            
            const inputElement = document.getElementById('json-batch-input');
            if (!inputElement) {
                console.error('æ‰¾ä¸åˆ°json-batch-inputå…ƒç´ ');
                alert('âŒ é¡µé¢å…ƒç´ é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return false;
            }
            
            const input = inputElement.value.trim();
            console.log('è¾“å…¥å†…å®¹:', input);
            
            if (!input) {
                alert('è¯·è¾“å…¥JSONå†…å®¹');
                return false;
            }
            
            try {
                console.log('å¼€å§‹è§£æJSON...');
                const data = JSON.parse(input);
                console.log('JSONè§£ææˆåŠŸ:', data);
                
                if (!Array.isArray(data)) {
                    alert('JSONå†…å®¹å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼\n\næ­£ç¡®æ ¼å¼ç¤ºä¾‹:\n[\n  {"prompt": "ä½ çš„æç¤º1"},\n  {"prompt": "ä½ çš„æç¤º2"}\n]');
                    return false;
                }
                
                if (data.length === 0) {
                    alert('JSONæ•°ç»„ä¸èƒ½ä¸ºç©º');
                    return false;
                }
                
                // éªŒè¯æ¯ä¸ªé¡¹ç›®æ˜¯å¦æœ‰promptå­—æ®µ
                for (let i = 0; i < data.length; i++) {
                    const item = data[i];
                    console.log(`éªŒè¯ç¬¬${i + 1}é¡¹:`, item);
                    
                    if (!item || typeof item !== 'object') {
                        alert(`ç¬¬${i + 1}ä¸ªé¡¹ç›®å¿…é¡»æ˜¯å¯¹è±¡æ ¼å¼\n\næ­£ç¡®æ ¼å¼: {"prompt": "ä½ çš„æç¤º"}`);
                        return false;
                    }
                    
                    if (!item.hasOwnProperty('prompt')) {
                        alert(`ç¬¬${i + 1}ä¸ªé¡¹ç›®ç¼ºå°‘promptå­—æ®µ\n\næ­£ç¡®æ ¼å¼: {"prompt": "ä½ çš„æç¤º"}`);
                        return false;
                    }
                    
                    if (typeof item.prompt !== 'string' || item.prompt.trim() === '') {
                        alert(`ç¬¬${i + 1}ä¸ªé¡¹ç›®çš„promptå­—æ®µå¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²\n\nå½“å‰å€¼: ${JSON.stringify(item.prompt)}`);
                        return false;
                    }
                }
                
                console.log('éªŒè¯é€šè¿‡!');
                alert(`âœ… JSONæ ¼å¼éªŒè¯é€šè¿‡ï¼\n\nå…±æœ‰ ${data.length} ä¸ªæç¤ºå¾…å¤„ç†\n\nç‚¹å‡»"å¼€å§‹æ‰¹é‡å¤„ç†"æŒ‰é’®å¼€å§‹å¤„ç†`);
                return true;
                
            } catch (error) {
                console.error('JSONè§£æé”™è¯¯:', error);
                alert(`âŒ JSONæ ¼å¼é”™è¯¯:\n\n${error.message}\n\nè¯·æ£€æŸ¥:\n1. æ˜¯å¦æœ‰å¤šä½™çš„é€—å·\n2. å¼•å·æ˜¯å¦é…å¯¹\n3. æ‹¬å·æ˜¯å¦é…å¯¹\n4. æ˜¯å¦æ˜¯æ ‡å‡†JSONæ ¼å¼`);
                return false;
            }
        }

        // æ‰¹é‡å¤„ç†ä¸»å‡½æ•°
        async function processBatch() {
            if (isLoading) return;
            
            if (!validateJsonInput()) {
                return;
            }
            
            const input = document.getElementById('json-batch-input').value.trim();
            const data = JSON.parse(input);
            
            // åˆå§‹åŒ–ç»Ÿè®¡ä¿¡æ¯
            batchStats = {
                total: data.length,
                success: 0,
                error: 0,
                tokens: 0
            };
            
            // æ˜¾ç¤ºè¿›åº¦æ¡å’Œç»Ÿè®¡ä¿¡æ¯
            showBatchProgress();
            updateBatchStats();
            
            // æ¸…ç©ºç»“æœåŒºåŸŸ
            const resultsDiv = document.getElementById('batch-results');
            resultsDiv.innerHTML = '';
            
            setLoading(true);
            
            try {
                const settings = getBatchSettings();
                const results = await processBatchWithConcurrency(data, settings);
                
                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                displayBatchResults(results, settings.includeMetadata);
                
            } catch (error) {
                console.error('æ‰¹é‡å¤„ç†å¤±è´¥:', error);
                alert('æ‰¹é‡å¤„ç†å¤±è´¥: ' + error.message);
            } finally {
                setLoading(false);
                hideBatchProgress();
            }
        }

        // è·å–æ‰¹é‡å¤„ç†è®¾ç½®
        function getBatchSettings() {
            return {
                model: getElementValue('batch-model') || 'gpt-3.5-turbo',
                max_tokens: parseInt(getElementValue('batch-max-tokens')) || 1000,
                temperature: parseFloat(getElementValue('batch-temperature')) || 0.7,
                concurrent: parseInt(getElementValue('batch-concurrent')) || 3,
                delay: parseInt(getElementValue('batch-delay')) || 1000,
                includeMetadata: document.getElementById('batch-include-metadata').checked
            };
        }

        // å¹¶å‘å¤„ç†æ‰¹é‡è¯·æ±‚
        async function processBatchWithConcurrency(data, settings) {
            const results = [];
            const chunks = chunkArray(data, settings.concurrent);
            
            for (let chunkIndex = 0; chunkIndex < chunks.length; chunkIndex++) {
                const chunk = chunks[chunkIndex];
                const chunkPromises = chunk.map(async (item, itemIndex) => {
                    const globalIndex = chunkIndex * settings.concurrent + itemIndex;
                    
                    try {
                        const startTime = Date.now();
                        const result = await callChatAPI(item.prompt, settings);
                        const endTime = Date.now();
                        
                        const processedResult = {
                            index: globalIndex,
                            prompt: item.prompt,
                            response: result.response,
                            success: true,
                            duration: endTime - startTime,
                            tokens: result.usage?.total_tokens || 0,
                            model: result.model
                        };
                        
                        batchStats.success++;
                        batchStats.tokens += processedResult.tokens;
                        
                        return processedResult;
                        
                    } catch (error) {
                        console.error(`å¤„ç†ç¬¬${globalIndex + 1}é¡¹å¤±è´¥:`, error);
                        
                        batchStats.error++;
                        
                        return {
                            index: globalIndex,
                            prompt: item.prompt,
                            success: false,
                            error: error.message || 'å¤„ç†å¤±è´¥'
                        };
                    } finally {
                        updateBatchProgress(globalIndex + 1, data.length);
                        updateBatchStats();
                    }
                });
                
                // ç­‰å¾…å½“å‰chunkå¤„ç†å®Œæˆ
                const chunkResults = await Promise.all(chunkPromises);
                results.push(...chunkResults);
                
                // åœ¨chunksä¹‹é—´æ·»åŠ å»¶è¿Ÿ
                if (chunkIndex < chunks.length - 1 && settings.delay > 0) {
                    await sleep(settings.delay);
                }
            }
            
            return results;
        }

        // è°ƒç”¨èŠå¤©API
        async function callChatAPI(prompt, settings) {
            const response = await axios.post('/api/chat', {
                message: prompt,
                model: settings.model,
                max_tokens: settings.max_tokens,
                temperature: settings.temperature
            });
            
            return response.data;
        }

        // æ˜¾ç¤ºæ‰¹é‡å¤„ç†ç»“æœ
        function displayBatchResults(results, includeMetadata) {
            const resultsDiv = document.getElementById('batch-results');
            const copyBtn = document.getElementById('copy-results-btn');
            
            const jsonResults = results.map(result => {
                const baseResult = {
                    index: result.index + 1,
                    prompt: result.prompt,
                    success: result.success
                };
                
                if (result.success) {
                    baseResult.response = result.response;
                    
                    if (includeMetadata) {
                        baseResult.metadata = {
                            duration_ms: result.duration,
                            tokens_used: result.tokens,
                            model: result.model
                        };
                    }
                } else {
                    baseResult.error = result.error;
                }
                
                return baseResult;
            });
            
            resultsDiv.innerHTML = `<div class="result-content">${JSON.stringify(jsonResults, null, 2)}</div>`;
            
            // æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
            if (copyBtn) {
                copyBtn.style.display = 'inline-block';
            }
        }

        // æ¸…ç©ºæ‰¹é‡å¤„ç†ç»“æœ
        function clearBatchResults() {
            const resultsDiv = document.getElementById('batch-results');
            const copyBtn = document.getElementById('copy-results-btn');
            
            resultsDiv.innerHTML = '<div class="result-placeholder">æ‰¹é‡å¤„ç†ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>';
            
            // éšè—å¤åˆ¶æŒ‰é’®
            if (copyBtn) {
                copyBtn.style.display = 'none';
            }
            
            hideBatchProgress();
            hideBatchStats();
        }

        // æ˜¾ç¤ºæ‰¹é‡å¤„ç†è¿›åº¦
        function showBatchProgress() {
            const progressDiv = document.getElementById('batch-progress');
            progressDiv.style.display = 'block';
            updateBatchProgress(0, batchStats.total);
        }

        // æ›´æ–°æ‰¹é‡å¤„ç†è¿›åº¦
        function updateBatchProgress(current, total) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            const percentage = total > 0 ? (current / total) * 100 : 0;
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `å¤„ç†ä¸­... ${current}/${total}`;
        }

        // éšè—æ‰¹é‡å¤„ç†è¿›åº¦
        function hideBatchProgress() {
            const progressDiv = document.getElementById('batch-progress');
            progressDiv.style.display = 'none';
        }

        // æ˜¾ç¤ºæ‰¹é‡å¤„ç†ç»Ÿè®¡
        function showBatchStats() {
            const statsDiv = document.getElementById('batch-stats');
            statsDiv.style.display = 'block';
        }

        // æ›´æ–°æ‰¹é‡å¤„ç†ç»Ÿè®¡
        function updateBatchStats() {
            showBatchStats();
            
            document.getElementById('stat-total').textContent = batchStats.total;
            document.getElementById('stat-success').textContent = batchStats.success;
            document.getElementById('stat-error').textContent = batchStats.error;
            document.getElementById('stat-tokens').textContent = batchStats.tokens;
        }

        // éšè—æ‰¹é‡å¤„ç†ç»Ÿè®¡
        function hideBatchStats() {
            const statsDiv = document.getElementById('batch-stats');
            statsDiv.style.display = 'none';
        }

        // å·¥å…·å‡½æ•°ï¼šå°†æ•°ç»„åˆ†å‰²æˆæŒ‡å®šå¤§å°çš„å—
        function chunkArray(array, chunkSize) {
            const chunks = [];
            for (let i = 0; i < array.length; i += chunkSize) {
                chunks.push(array.slice(i, i + chunkSize));
            }
            return chunks;
        }

        // å·¥å…·å‡½æ•°ï¼šå»¶è¿Ÿæ‰§è¡Œ
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        let uploadedFiles = [];

        // é¡µé¢åˆå§‹åŒ–æ—¶ç»‘å®šæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
        function initFileUpload() {
            const fileInput = document.getElementById('file-input');
            const uploadZone = document.getElementById('file-upload-zone');
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½äº‹ä»¶
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleDrop);
            uploadZone.addEventListener('click', triggerFileSelect);
        }

        // è§¦å‘æ–‡ä»¶é€‰æ‹©
        function triggerFileSelect() {
            document.getElementById('file-input').click();
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            processFiles(files);
        }

        // å¤„ç†æ‹–æ‹½æ‚¬åœ
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragover');
        }

        // å¤„ç†æ‹–æ‹½ç¦»å¼€
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        }

        // å¤„ç†æ–‡ä»¶æ‹–æ‹½æ”¾ä¸‹
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files);
            processFiles(files);
        }

        // å¤„ç†æ–‡ä»¶
        async function processFiles(files) {
            let successCount = 0;
            for (const file of files) {
                if (validateFile(file)) {
                    const fileData = await readFile(file);
                    uploadedFiles.push(fileData);
                    successCount++;
                }
            }
            
            if (successCount > 0) {
                updateFileDisplay();
                showUploadSuccess(successCount);
                
                // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                setTimeout(() => {
                    document.getElementById('chat-input').focus();
                }, 500);
            }
        }

        // éªŒè¯æ–‡ä»¶
        function validateFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [
                'image/jpeg', 'image/png', 'image/gif', 'image/webp',
                'text/plain', 'text/markdown', 'application/pdf',
                'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ];
            
            if (file.size > maxSize) {
                alert(`æ–‡ä»¶ "${file.name}" è¶…è¿‡10MBå¤§å°é™åˆ¶`);
                return false;
            }
            
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(txt|md)$/i)) {
                alert(`æ–‡ä»¶ "${file.name}" æ ¼å¼ä¸æ”¯æŒ`);
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»ä¸Šä¼ è¿‡ç›¸åŒæ–‡ä»¶
            const existingFile = uploadedFiles.find(f => f.name === file.name && f.size === file.size);
            if (existingFile) {
                alert(`âš ï¸ æ–‡ä»¶ "${file.name}" å·²ç»ä¸Šä¼ è¿‡äº†\nå¦‚éœ€é‡æ–°ä¸Šä¼ ï¼Œè¯·å…ˆåˆ é™¤ç°æœ‰æ–‡ä»¶`);
                return false;
            }
            
            return true;
        }

        // è¯»å–æ–‡ä»¶
        async function readFile(file) {
            const fileData = {
                id: Date.now() + Math.random(),
                name: file.name,
                size: file.size,
                type: file.type,
                isImage: file.type.startsWith('image/'),
                content: null,
                base64: null
            };
            
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                if (fileData.isImage) {
                    reader.onload = (e) => {
                        fileData.base64 = e.target.result;
                        resolve(fileData);
                    };
                    reader.readAsDataURL(file);
                } else {
                    reader.onload = (e) => {
                        fileData.content = e.target.result;
                        resolve(fileData);
                    };
                    reader.readAsText(file);
                }
            });
        }

        // æ›´æ–°æ–‡ä»¶æ˜¾ç¤º
        function updateFileDisplay() {
            const uploadedFilesDiv = document.getElementById('uploaded-files');
            const fileList = document.getElementById('file-list');
            const fileCountSpan = document.getElementById('file-count');
            const fileSizeTotalSpan = document.getElementById('file-size-total');
            
            if (uploadedFiles.length === 0) {
                uploadedFilesDiv.style.display = 'none';
                fileCountSpan.textContent = '0';
                fileSizeTotalSpan.textContent = 'æ€»å¤§å°: 0 B';
                return;
            }
            
            uploadedFilesDiv.style.display = 'block';
            fileList.innerHTML = '';
            
            let totalSize = 0;
            uploadedFiles.forEach(file => {
                totalSize += file.size;
                const fileItem = createFileItem(file);
                fileList.appendChild(fileItem);
            });
            
            fileCountSpan.textContent = uploadedFiles.length;
            fileSizeTotalSpan.textContent = `æ€»å¤§å°: ${formatFileSize(totalSize)}`;
        }

        // åˆ›å»ºæ–‡ä»¶é¡¹ç›®
        function createFileItem(file) {
            const fileItem = document.createElement('div');
            fileItem.className = `file-item ${file.isImage ? 'image' : ''}`;
            
            let fileIcon = 'ğŸ“„';
            if (file.isImage) fileIcon = 'ğŸ–¼ï¸';
            else if (file.type.includes('pdf')) fileIcon = 'ğŸ“•';
            else if (file.name.match(/\.(doc|docx)$/i)) fileIcon = 'ğŸ“„';
            else if (file.name.match(/\.(txt|md)$/i)) fileIcon = 'ğŸ“ƒ';
            
            fileItem.innerHTML = `
                ${file.isImage ? `<img src="${file.base64}" class="image-preview" alt="${file.name}">` : ''}
                <span class="file-icon">${fileIcon}</span>
                <div class="file-info">
                    <div class="file-name" title="${file.name}">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                </div>
                <button class="remove-file" onclick="removeFile('${file.id}')" title="åˆ é™¤æ–‡ä»¶">Ã—</button>
            `;
            
            return fileItem;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // åˆ é™¤æ–‡ä»¶
        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(file => file.id != fileId);
            updateFileDisplay();
        }

        // æ¸…é™¤æ‰€æœ‰æ–‡ä»¶
        function clearUploadedFiles() {
            if (uploadedFiles.length > 0) {
                const confirmed = confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ ${uploadedFiles.length} ä¸ªæ–‡ä»¶å—ï¼Ÿ`);
                if (!confirmed) return;
            }
            
            uploadedFiles = [];
            updateFileDisplay();
            document.getElementById('file-input').value = '';
        }

        // æ·»åŠ æˆåŠŸä¸Šä¼ æç¤º
        function showUploadSuccess(fileCount) {
            const uploadZone = document.getElementById('file-upload-zone');
            const originalIcon = uploadZone.querySelector('.upload-icon');
            
            // ä¸´æ—¶æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            originalIcon.textContent = 'âœ…';
            uploadZone.style.borderColor = '#28a745';
            uploadZone.style.background = '#d4edda';
            
            // æ˜¾ç¤ºæç¤ºæ–‡æœ¬
            const hint = uploadZone.querySelector('.upload-hint');
            const originalText = hint.textContent;
            hint.textContent = `æˆåŠŸä¸Šä¼  ${fileCount} ä¸ªæ–‡ä»¶ï¼`;
            hint.style.color = '#155724';
            
            // 2ç§’åæ¢å¤åŸçŠ¶
            setTimeout(() => {
                originalIcon.textContent = 'ğŸ“';
                uploadZone.style.borderColor = '';
                uploadZone.style.background = '';
                hint.textContent = originalText;
                hint.style.color = '';
            }, 2000);
        }

        // å¤åˆ¶æ‰¹é‡å¤„ç†ç»“æœ
        async function copyBatchResults() {
            const resultsDiv = document.getElementById('batch-results');
            const resultContent = resultsDiv.querySelector('.result-content');
            
            if (!resultContent) {
                alert('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„ç»“æœ');
                return;
            }
            
            const resultsText = resultContent.textContent;
            await copyToClipboard(resultsText, 'copy-results-btn', 'JSONæ‰¹é‡å¤„ç†ç»“æœ');
        }

        // æ·»åŠ å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // Ctrl+U æˆ– Cmd+U å¿«é€Ÿä¸Šä¼ 
            if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                e.preventDefault();
                triggerFileSelect();
            }
            
            // Escape é”®æ¸…é™¤æ‰€æœ‰æ–‡ä»¶
            if (e.key === 'Escape' && uploadedFiles.length > 0) {
                clearUploadedFiles();
            }
            
            // å·²æœ‰çš„å¤åˆ¶å¿«æ·é”®...
            if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                const activeElement = document.activeElement;
                const resultsDiv = document.getElementById('batch-results');
                
                if (resultsDiv && resultsDiv.contains(activeElement)) {
                    e.preventDefault();
                    copyBatchResults();
                }
            }
        });

        // æ–‡æœ¬è¡¥å…¨ç»“æœå¤åˆ¶åŠŸèƒ½
        async function copyCompletionResult() {
            const resultDiv = document.getElementById('completion-result');
            const resultContent = resultDiv.querySelector('.result-content');
            
            if (!resultContent) {
                alert('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„ç»“æœ');
                return;
            }
            
            const resultText = resultContent.textContent;
            await copyToClipboard(resultText, 'copy-completion-btn', 'æ–‡æœ¬è¡¥å…¨ç»“æœ');
        }

        // èŠå¤©å¯¹è¯å¤åˆ¶åŠŸèƒ½
        async function copyChatHistory() {
            const messagesDiv = document.getElementById('chat-messages');
            const messages = messagesDiv.querySelectorAll('.message');
            
            if (messages.length === 0) {
                alert('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„å¯¹è¯å†…å®¹');
                return;
            }
            
            let chatText = '';
            messages.forEach(message => {
                const role = message.querySelector('.message-role').textContent;
                const content = message.querySelector('.message-content').textContent;
                chatText += `${role}: ${content}\n\n`;
            });
            
            await copyToClipboard(chatText.trim(), 'copy-chat-btn', 'èŠå¤©å¯¹è¯');
        }

        // é€šç”¨å¤åˆ¶å‡½æ•°
        async function copyToClipboard(text, buttonId, contentType) {
            const copyBtn = document.getElementById(buttonId);
            
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // å›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-999999px';
                    textarea.style.top = '-999999px';
                    document.body.appendChild(textarea);
                    textarea.focus();
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                if (copyBtn) {
                    const originalText = copyBtn.textContent;
                    const originalBg = copyBtn.style.backgroundColor;
                    
                    copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
                    copyBtn.style.backgroundColor = '#28a745';
                    copyBtn.style.color = 'white';
                    copyBtn.disabled = true;
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.backgroundColor = originalBg;
                        copyBtn.disabled = false;
                    }, 2000);
                }
                
                console.log(`${contentType}å¤åˆ¶æˆåŠŸ`);
                
            } catch (error) {
                console.error(`${contentType}å¤åˆ¶å¤±è´¥:`, error);
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶æ–‡æœ¬');
            }
        }
    </script>
</body>
</html> 